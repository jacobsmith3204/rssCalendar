<!DOCTYPE html>
<html>

<head>
    <title>rssCalendar</title>
    <script src="/client.js"></script>
    <!--script src="/googleCalendarIntergration.js"></script-->

    <meta charset="utf-8" />
</head>

<body>

    <button onclick="PressedButton()"> Create RSS Feed</button>

    <br>
    <br>





    <p>Google Calendar API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out (HIDDEN BY DEFAULT)-->



    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <div id="authorized">
        SUCCESSFULLY AUTHORISED
        <button id="authorize_button" onclick="getCalendarInfo()">Request </button>
        <div id="results">
        </div>
    </div>


    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script>

        var id;
        function handleAuthClick() {

            fetch(`${location.origin}/calendar/startoauth`)
                .then(response => response.json()).then(onData) // Parse JSON response
                .catch(error => console.error(error)); // Handle errors


            function onData(data) {
                console.log(data);
                var url = data["oauthurl"];
                console.log(url);
                if (url != undefined) {
                    // catches when the created window is closed. 
                    window.addEventListener("message", (event) => {

                        console.log(event, "event data", event.data);
                        // expexts the message to be a json object 
                       
                        var obj = JSON.parse(event.data);
                        console.log(event.data, obj);
                        if(!obj)
                            return; 

                        if (obj.type == "oauth successful") {                        
                            id = obj.id; // assign an id to this object from the callback redirect when it closes to finish the verification. 

                            console.log("closed window Sucessful Oauth");
                            document.getElementById('authorized').style.visibility = 'visible';
                            document.getElementById('authorize_button').style.visibility = 'hidden';
                        }
                        else {
                            console.log("closed window");
                        }
                    });

                    var redirect = window.open(url, "_blank");
                    console.log("opening window");
                }
            }
        }

        function getCalendarInfo() {
            fetch(`${location.origin}/calendar/requestdata?id=${id}`)
                .then(response => response.json()).then(onData)
                .catch(error => console.error(error)); // Handle errors

            function onData(data) { 
                console.log("request for calendar data found:",data);

                // gets only the summary from the data
                var simplified = {summary: data.summary, items: []}
                data.items.forEach(item => {simplified.items.push(item.summary); });

                // writes it to the results div. 
                document.getElementById('results').innerText = JSON.stringify(simplified);
            }
        }

        function handleSignoutClick() {
            // does nothing
        }

        //document.getElementById('authorize_button').style.visibility = 'hidden';
        document.getElementById('signout_button').style.visibility = 'hidden';
        document.getElementById('authorized').style.visibility = 'hidden';

    </script>
    <style>
        body {
            color: rgb(168, 168, 168);
            font-size: 1.3rem;
            background-color: rgb(34, 34, 34);

        }
    </style>

</body>

</html>